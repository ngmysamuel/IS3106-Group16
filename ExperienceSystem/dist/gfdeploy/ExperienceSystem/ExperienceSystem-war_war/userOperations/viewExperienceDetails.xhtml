<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="./../templates/defaultTemplate.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp">

    <ui:define name="content">
        <style>
            #topBox {
                position: relative;
                width: 65%;
                height: 250px;
                margin: auto;
                display: flex; 
                justify-content: space-between;
                align-items: center;
            }
            #blackBox {
                width: 25%;
                height: 100%;
                background-color: black;
            }
            #topPicture{
                width: 73%; 
                height:100%;
            }
            
            #titleHeader{
                position: relative;
                width: 65%;
                height: 100px;
                margin: auto;
                display: flex; 
                justify-content: flex-start;
                align-items: center;
            }
            
            #detailsBox{
                position: relative;
                width: 65%;
                margin: auto;
                display: flex; 
                justify-content: space-between;
                
            }
            #leftColumn{
                width:65%;

            }
            .detailTitleClass{
                width:20%;
            }
            .detailContentClass{
                width:80%;
            }
            #rightColumn{
                width:30%;
            }
            
            #formBookExperience{
                border: 1px solid black;
                padding: 15px;
                position: sticky;
                top: 0;
            }
            
            
        </style>
            
        <div id="topBox">
            <div id="blackBox">
                <p style="overflow:auto; position: absolute; left: 15px; bottom: 0; color: white; font-size: 20px;">EXPERIENCES</p>    
            </div>

            <div id="topPicture">
                <img style="object-fit:cover; width:100%; height:100%;" src="https://i.imgur.com/2hocHvd.jpg" />
            </div>
        </div>
        <h:form id="formFollowExperience">
            <div id="titleHeader">
                <span>
                    <p:link outcome="searchExperience.xhtml" style="margin-right:20px; font-size: 30px; color: black;" value="Back"/>
                </span>
                <span>
                    <p:outputLabel value=" |    " style="font-size: 30px;"/>
                </span>
                <span>
                    <p:outputLabel value="#{viewExperienceDetailsManagedBean.experience.title}" style="font-size: 30px;"/>
                </span>
                <span style="margin-left: 10px;">
                    <p:commandButton id="favourateExperienceButton" value="Follow this experience" icon="ui-icon-heart"  update="@form" rendered="#{sessionScope.isLogin != null and sessionScope.isLogin != false and !viewExperienceDetailsManagedBean.isExperienceFavouratedByThisUser}" actionListener="#{viewExperienceDetailsManagedBean.addFavoriteExperience}" />
                    <p:commandButton id="unfavourateExperienceButton" value="Unfollow this experience" icon="ui-icon-closethick" update="@form" rendered="#{sessionScope.isLogin != null and sessionScope.isLogin != false and viewExperienceDetailsManagedBean.isExperienceFavouratedByThisUser}" actionListener="#{viewExperienceDetailsManagedBean.removeFavoriteExperience}" />
                </span>
            </div>
        </h:form> 
        
        <div id="detailsBox">
            <div id="leftColumn">
                <p:galleria value="#{viewExperienceDetailsManagedBean.images}" var="image" panelWidth="545" panelHeight="313" showCaption="false">
                    <p:graphicImage style="width:100%; height: 100%; object-fit: cover;" url="#{image}" alt="Image Description" title="image"/>
                </p:galleria>
                <br />
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Title" /> 
                    <h:outputText value="#{viewExperienceDetailsManagedBean.experience.title}" /> 
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Average rating" /> 
                    <p:rating disabled="true" value="#{viewExperienceDetailsManagedBean.experience.averageScore}" rendered="#{viewExperienceDetailsManagedBean.experience.averageScore != null}" />
                    <h:outputText value="No Rating Yet" rendered="#{viewExperienceDetailsManagedBean.experience.averageScore == null}" />                                  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Category" /> 
                    <h:outputText value="#{viewExperienceDetailsManagedBean.experience.category.name}" />  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Language" /> 
                    <h:outputText value="#{viewExperienceDetailsManagedBean.experience.language.name}" />  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Type" /> 
                    <h:outputText value="#{viewExperienceDetailsManagedBean.experience.type.name}" />  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Location" /> 
                    <h:outputText value="#{viewExperienceDetailsManagedBean.experience.location.name}" />  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Address" /> 
                    <h:outputText style="width:100%;" value="#{viewExperienceDetailsManagedBean.experience.address}" />  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Description" /> 
                    <h:outputText value="#{viewExperienceDetailsManagedBean.experience.description}" />  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Items Provided" /> 
                    <h:outputText value="#{viewExperienceDetailsManagedBean.experience.providingItems}" />  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Items Required" /> 
                    <h:outputText value="#{viewExperienceDetailsManagedBean.experience.requiringItems}" />  
                </p:panelGrid>
                <br />
                
                <p:panelGrid style="width:100%;" columns="2" columnClasses="detailTitleClass,detailContentClass" layout="grid">
                    <h:outputText style="font-weight:bold;" value="Host" /> 
                    <p:link outcome="#{viewExperienceDetailsManagedBean.viewOtherUserInfo()}" value="#{viewExperienceDetailsManagedBean.experience.host.username}" />  
                </p:panelGrid>
                <br />
            </div>
            
            <div id="rightColumn">
                <h:form id="formBookExperience">
                    <div style="width:85%; margin:auto; border-left: 1px solid black; padding:10px;">
                        <p:outputLabel value="Average" style="font-size: 15px;" />
                        <br />
                        <p:outputLabel value="$#{viewExperienceDetailsManagedBean.experience.averagePrice}" style="font-size: 30px;" />
                        <br />
                        <p:outputLabel value="Per Ticket" style="font-size: 15px;" />
                    </div>
                    <br />
                    <br />
                    <div style="width:85%; margin:auto;">
                        <p:outputLabel for="bookDate" value="Experience Date" />
                        <p:growl id="messageBookExperience" showDetail="true" />
                        
                        <p:selectOneMenu id="bookDate" value="#{viewExperienceDetailsManagedBean.selectedExperienceDateIdToBook}" style="width:160px;" required="true" requiredMessage="Please select a date" >
                            <f:selectItem itemValue="null" itemLabel="Select" noSelectionOption="true" />
                            <f:selectItems value="#{viewExperienceDetailsManagedBean.experience.experienceDates}" var="experienceDate" itemValue="#{experienceDate.experienceDateId}" itemLabel="#{viewExperienceDetailsManagedBean.convertDateToString(experienceDate.startDate)}" />
                            <p:ajax update="@form" />
                        </p:selectOneMenu>
                        <p:message for="bookDate" />
                        <br/>
                        <br/>
                        
                        <p:outputLabel for="bookNumOfTickets" value="Number of People" rendered="#{viewExperienceDetailsManagedBean.selectedExperienceDate != null}" />
                        <br/>
                        <p:spinner id="bookNumOfTickets" label="Select" value="#{viewExperienceDetailsManagedBean.numOfPeopleForBooking}" min="1" max="#{viewExperienceDetailsManagedBean.selectedExperienceDate.spotsAvailable}" required="true" requiredMessage="Please select the number of ticket(s)" rendered="#{viewExperienceDetailsManagedBean.selectedExperienceDate != null}" >
                            <p:ajax update="@form" />
                        </p:spinner>
                        <br/>
                        <br/>
                        
                        <p:panelGrid style="width:100%;" rendered="#{viewExperienceDetailsManagedBean.selectedExperienceDate != null and viewExperienceDetailsManagedBean.numOfPeopleForBooking != null}">
                            <p:row>
                                <p:column>
                                    <p:outputLabel value="Price Before Tax" style="font-size: 15px;font-weight:bold;" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="$" />
                                    <h:outputText value="#{viewExperienceDetailsManagedBean.selectedExperienceDate.price * viewExperienceDetailsManagedBean.numOfPeopleForBooking}" style="font-size: 15px;" >
                                        <f:convertNumber type="number" maxFractionDigits="2" />
                                    </h:outputText>
                                </p:column>
                            </p:row>
                            <p:row>
                                <p:column>
                                    <p:outputLabel value="Tax" style="font-size: 15px;font-weight:bold;" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="$" />
                                    <h:outputText value="#{viewExperienceDetailsManagedBean.selectedExperienceDate.price * viewExperienceDetailsManagedBean.numOfPeopleForBooking * 0.07}" style="font-size: 15px;" >
                                        <f:convertNumber type="number" maxFractionDigits="2" />
                                    </h:outputText>
                                </p:column>
                            </p:row>
                            <p:row>
                                <p:column>
                                    <p:outputLabel value="Total Price" style="font-size: 15px;font-weight:bold;" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="$" />
                                    <h:outputText value="#{viewExperienceDetailsManagedBean.selectedExperienceDate.price * viewExperienceDetailsManagedBean.numOfPeopleForBooking * 1.07}" style="font-size: 15px;" >
                                        <f:convertNumber type="number" maxFractionDigits="2" />
                                    </h:outputText>
                                </p:column>
                            </p:row>
                        </p:panelGrid>
                        <br/>
                        
                        <p:commandButton id="bookNowLogin" update="messageBookExperience formCheckout" value="Book Now" actionListener="#{viewExperienceDetailsManagedBean.proceedToCheckOut}" oncomplete="PF('dialogCheckout').show()" rendered="#{(sessionScope.isLogin != null and sessionScope.isLogin == true) and viewExperienceDetailsManagedBean.selectedExperienceDateIdToBook != null and viewExperienceDetailsManagedBean.numOfPeopleForBooking != null}" />
                        <p:commandButton id="bookNowNotLogin" update="messageBookExperience" value="Book Now" oncomplete="{PF('dialogLogIn').show()}" rendered="#{(sessionScope.isLogin == null or sessionScope.isLogin == false) and viewExperienceDetailsManagedBean.selectedExperienceDateIdToBook != null and viewExperienceDetailsManagedBean.numOfPeopleForBooking != null}" /> 
                    </div>

                </h:form>
            </div>
        </div>     
        
        <h:form id="formCheckout">
            <p:dialog id="dialogCheckout" widgetVar="dialogCheckout" header="Checkout" closable="true" width="500" blockScroll="true">
                <p:growl id="messagesCheckout" redisplay="false" />
                <p:ajax event="close" listener="#{viewExperienceDetailsManagedBean.initializeBookingState}" />
                <div style="overflow: scroll; max-height: 100%;">
                    <p:outputLabel value="Order Summary" />
                    <hr />
                    <p:panelGrid columns="2" style="width:100%;" layout="grid">
                        <p:outputLabel value="Experience Title" style="font-weight:bold;" />
                        <p:outputLabel value="#{viewExperienceDetailsManagedBean.experience.title}" />
                        
                        <p:outputLabel value="Date" style="font-weight:bold;" />
                        <p:outputLabel value="#{viewExperienceDetailsManagedBean.convertDateToString(viewExperienceDetailsManagedBean.selectedExperienceDate.startDate)}" />
                        
                        <p:outputLabel value="Guests" style="font-weight:bold;" />
                        <p:outputLabel value="#{viewExperienceDetailsManagedBean.numOfPeopleForBooking}" />
                        
                    </p:panelGrid>
                    <hr />
                    <p:panelGrid columns="2" style="width:100%;" layout="grid" rendered="#{viewExperienceDetailsManagedBean.subtotal != null}">
                        <h:outputText value="Subtotal:" style="font-weight:bold;" />
                        <h:outputText value="#{viewExperienceDetailsManagedBean.subtotal}"  >
                            <f:convertNumber type="currency" currencySymbol="$" maxIntegerDigits="5" maxFractionDigits="2"/>
                        </h:outputText>
                        
                        <h:outputText value="Tax(7%):" style="font-weight:bold;" />
                        <h:outputText value="#{viewExperienceDetailsManagedBean.tax}"  >
                            <f:convertNumber type="currency" currencySymbol="$" maxIntegerDigits="5" maxFractionDigits="2"/>
                        </h:outputText>
                        
                    </p:panelGrid>
                    <hr />
                    <p:panelGrid columns="2" style="width:100%;" layout="grid">
                        <h:outputText value="Total:" style="font-weight:bold;" />
                        <h:outputText value="#{viewExperienceDetailsManagedBean.total}"  >
                            <f:convertNumber type="currency" currencySymbol="$" maxIntegerDigits="5" maxFractionDigits="2"/>
                        </h:outputText>
                    </p:panelGrid>
                    <br />
                    
                    <p:outputLabel value="Guest Details" style="font-weight:bold;" />
                    <hr />
                    <h:outputText value="We use your account personal information as your guest details for every booking. Please go to your account settings to make sure you fill in all the information, otherwise this booking won't be made." />
                    <br />
                    <br />
                    <p:panelGrid columns="2" style="width:100%;" layout="grid">
                        <p:outputLabel value="First Name" style="font-weight:bold;" />
                        <h:outputText value="#{viewExperienceDetailsManagedBean.currentUser.firstName}" />

                        <p:outputLabel value="Last Name" style="font-weight:bold;" />
                        <h:outputText value="#{viewExperienceDetailsManagedBean.currentUser.lastName}" />

                        <p:outputLabel value="Email Address" style="font-weight:bold;" />
                        <h:outputText value="#{viewExperienceDetailsManagedBean.currentUser.email}" />

                        <p:outputLabel value="Phone Number" style="font-weight:bold;" />
                        <h:outputText value="#{viewExperienceDetailsManagedBean.currentUser.phoneNumber}" />

                    </p:panelGrid>
                    <br />
                    <p:commandButton value="Book Now" rendered="#{viewExperienceDetailsManagedBean.newBooking.bookingId == null}" update="@form" actionListener="#{viewExperienceDetailsManagedBean.checkout}" oncomplete="PF('dialogCheckout').show()" />

                    <br />
                </div>
            </p:dialog>
        </h:form>
        
    </ui:define>

</ui:composition>
